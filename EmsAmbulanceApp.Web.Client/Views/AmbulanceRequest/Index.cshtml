<div class="ambulance-card">
    <div class="header">
        <button class="menu-btn">‚ò∞</button>
        <div class="search-bar">
            <input id="location" placeholder="Enter Incident Location" class="location-input">
            <span class="search-btn">üîç</span>
        </div>
    </div>
    <div class="map" id="map"></div>
    <div class="centered-pin">
        üìç <!-- You can replace this with an image or any pin icon -->
    </div>
    <br/>
    <div class="app-btn-group">
        <a class="btn book-ambulance" asp-area="" asp-controller="AmbulanceRequest" asp-action="Request">BOOK AMBULANCE</a>
    </div>
</div>


@section Scripts
{
    <script src="~/js/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/js/liveTracking.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAuEhOLt7dHcJFaCinq9Rj3I5BTM2LwlU&region=NL&callback=initMap&v=weekly&libraries=places" defer></script>
    <script>

        let map;
        let locationInput = document.getElementById("location");
        let mapElement = document.getElementById("map");
        let autocomplete;

        function initMap() {
            map = new google.maps.Map(mapElement, {
                zoom: 12,
                center: { lat: 51.9244, lng: 4.4777 },
                disableDefaultUI: true,
            });

            getCurrentLocation();
            map.addListener('dragend', handleDragEnd);

            autocomplete = new google.maps.places.SearchBox(locationInput);
            autocomplete.addListener('places_changed', onPlaceChanged);
        }

        function onPlaceChanged() {
            var place = autocomplete.getPlaces();
            if (place[0].geometry) {
                map.panTo(place[0].geometry.location);
                map.setZoom(15);
                map.setCenter(place[0].geometry.location);
            } else {
                document.getElementById('location').placeholder = 'Enter Incident Location';
            }
        }

        function getCurrentLocation() {
            let infoWindow = new google.maps.InfoWindow();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(

                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        infoWindow.setPosition(pos);
                        infoWindow.setContent("Your Location");
                        infoWindow.open(map);
  
                        map.setCenter(pos);
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    },
                );
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        }

        function handleDragEnd() {
            var center = map.getCenter();
            var latlng = { lat: center.lat(), lng: center.lng() };

            // Initialize the Geocoder
            var geocoder = new google.maps.Geocoder();

            geocoder.geocode({ 'location': latlng }, function (results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        locationInput.value = results[0].formatted_address;
                        locationInput.dispatchEvent(new Event('change', {
                            bubbles: true,
                            cancelable: true
                        }));

                        map.setCenter(latlng);
                    } else {
                        window.alert('No results found');
                    }
                } else {
                    window.alert('Geocoder failed due to: ' + status);
                }
            });
        }

        

        window.initMap = initMap;
    </script>
}